function Hotel(u,page_id,hotelDb){this.id;this.pushnote_id;this.hash_url=u;this.menu;this.subCategories=[];this.menuPlugins=[];this.menuTopItems=[];this.plugIns=[];this.user_name="";this.user_surname="";this.user_sex="";this.user_name="";this.vip_pass;this.user_id="-1";this.user_title;this.user_enabled_counter;this.room_number="";this.rootFilePath;this.RootFileSystem;this.current_view="";this.Memory=hotelDb;this.logo;this.description;this.welcome_message;this.backgroundType;this.background;this.hotel_data;this.page_id=page_id;this.notes_lifespan=1;this.push_last_receive=0;this.initialize=function(id){var self=this;var vars=getUrlVars(this.hash_url.hash);this.id=vars["id"];this.cleanUpPushNotifications();this.setContext()};this.render=function(){var self=this;var template=Handlebars.compile($("#hotel_first_page").html());var html=template(self.hotel_data);var $page=$(page_id);$page.find(".ui-content").html(html);setFullScreen();var short_desc=$page.find(".main_description").html();var endofstr="...";var readmore=1;if(short_desc.length<=MAX_SHORT_DESC){endofstr="";readmore=0}short_desc=short_desc.substring(0,MAX_SHORT_DESC)+""+endofstr;$page.find(".welcome_message").html(short_desc);if($page.find(".main_description").hasClass("show_on_first_load")){$page.find(".main_description_short").addClass("show_on_first_load")}if(readmore==1){$page.find(".toolbar_arrow_btn_root ").addClass("show_button_on_first_load");$page.find(".toolbar_arrow_btn_root ").removeClass("hidden_button_on_first_load")}self.menu=new HotelMenu(self.getMenuPlugins(),self.getMenuTopItems(),self.vip_pass,self.logo);if(self.vip_pass=="true"){$("#menu_username").html(self.user_title+" "+self.user_name+" "+self.user_surname);$("#menu_room_no").html(self.room_number);$("#menu_vip_enabled").html("Signed In")}$(".menu_plugins").html(self.menu.renderPlugIns());$(".menu_topItems").html(self.menu.renderTopItems());$("#side_menu_logo").html("<img src='"+self.logo+"' />");if(self.vip_pass=="true"){$(".vipEnabled").removeClass("hidden")}else{$(".vipEnabled").addClass("hidden");$(".enableVip").show()}};this.setContext=function(){var self=this;this.rootFilePath=app.localFilePath+"/"+app.app_dir+"/dir"+this.id+"/";this.Memory.db.get(this.id,function(err,doc){if(err){return err}doc.logo=self.rootFilePath+removeUrl(doc.logo);doc.background=self.rootFilePath+removeUrl(doc.background);self.hotel_data={logo:doc.logo,description:doc.description,backgroundType:doc.backgroundType,background:doc.background,welcome_message:doc.welcome_message};self.logo=doc.logo;self.description=doc.description;self.backgroundType=doc.backgroundType;self.background=doc.background;self.menuPlugins=doc.plugIns;self.menuTopItems=doc.MenuTopItems;self.vip_pass=doc.vip_pass;self.welcome_message=doc.welcome_message;self.user_name=doc.user_name;self.user_surname=doc.user_surname;self.user_sex=doc.user_sex;self.vip_pass=doc.vip_pass;self.pushnote_id=doc.pushnote_id;self.user_title=doc.user_title;self.user_id=doc.user_id;self.room_number=doc.room_number;self.push_last_receive=doc.push_last_receive;self.render();self.receivePushNotification();app.interval_id=setInterval(self.receivePushNotification,6e5);var ping_host="http://www.oneappy.com/api/m.php?m=servertime";$.ajax({type:"POST",url:ping_host,success:function(data){var ret_t=jQuery.parseJSON(data);var note_date=ret_t["curtime"];var stringToEncode=app.appy_uid+"."+note_date;var hash=window.btoa(stringToEncode);var host="http://www.oneappy.com/api/m.php?m=weather&hotel_id="+self.id+"&hash="+hash;console.log("UID "+app.appy_uid);console.log("HASH "+host);$.ajax({type:"POST",url:host,success:function(data){ret=jQuery.parseJSON(data);self.Memory.db.get("weather_tmpl_"+self.id).then(function(doc){doc.weather=ret["weather"];doc.delete_id=self.id;app.HotelDb.db.put(doc).then(function(result){}).catch(function(){var msg="Could not Retrieve Weather Data, check connectivity and try again.";display_info_message(msg)})}).catch(function(){ret["_id"]="weather_tmpl_"+self.id;ret["delete_id"]=self.id;app.HotelDb.db.put(ret).then(function(result){}).catch(function(){})})},error:function(err){display_info_message("There seems to be a problem and the weather service is not available at the moment.")}})},error:function(err){}})})};this.getMenuPlugins=function(){return this.menuPlugins};this.getMenuTopItems=function(){return this.menuTopItems},this.create_subcat=function(u,options){var vars=getUrlVars(u.hash);var id=vars["id"];var title=vars["title"];var hotelLeaf=this.checkIfLeafExists(id);if(typeof hotelLeaf==="boolean"){hotelLeaf=new HotelLeaf(title,id,this.menu,this.id,this.Memory);this.subCategories.push(hotelLeaf)}this.current_view=hotelLeaf;var $page=hotelLeaf.$page_div;$page.page();$.mobile.changePage($page,options)};this.checkIfLeafExists=function(id){var hotelLeaf=false;for(i=0;i<this.subCategories.length;i++){if(this.subCategories[i].id==id){hotelLeaf=this.subCategories[i]}}return hotelLeaf};this.create_plugin=function(u,options){var vars=getUrlVars(u.hash);var tmpl=vars["template"];var title=vars["title"];var plugIn=this.checkIfPluginExists(tmpl);if(typeof plugIn==="boolean"){plugIn=new PlugIn(this.id,title,tmpl,this.menu,this.Memory.db);this.plugIns[tmpl]=plugIn}else{plugIn.setContext()}this.current_view=plugIn;var $page=plugIn.$page_div;$page.page();$.mobile.changePage($page,options)};this.checkIfPluginExists=function(tmpl){var plugin=false;for(i=0;i<this.plugIns.length;i++){if(this.plugIns[i].template==tmpl){plugin=this.plugIns[i]}}return plugin};this.addToBookmarks=function(leafid,bookmark_type){var self=this;var root_id=this.id;var put_id=bookmark_type[0]+"_"+root_id+"_"+leafid;var Leaftitle="";this.Memory.db.get(leafid).then(function(doc1){Leaftitle=doc1.title;if(bookmark_type[0]=="bookmark"){doc1.bookmark="true";bookmark_type[1]="0";bookmark_type[2]="0"}else if(bookmark_type[0]=="places"){doc1.places="true"}self.Memory.db.put(doc1).catch(function(err){});self.Memory.db.get(put_id).then(function(doc){}).catch(function(err){if(err.status===404){self.Memory.db.put({_id:put_id,type:bookmark_type[0],title:Leaftitle,leaf_id:leafid,longtitude:bookmark_type[1],latitude:bookmark_type[2],delete_id:self.id})}})}).catch(function(err){})};this.deleteFromBookmarks=function(leafid,reset_view,boomark_type){var self=this;var root_id=this.id;var put_id=boomark_type+"_"+root_id+"_"+leafid;var Leaftitle="";this.Memory.db.get(leafid).then(function(doc1){Leaftitle=doc1.title;if(boomark_type=="bookmark"){doc1.bookmark="false"}else if(boomark_type=="places"){doc1.places="false";if($(".hotel_leaf").find("#map_box").length<1){$("#repository").append($("#map_box"))}}self.Memory.db.put(doc1).then(function(response){self.Memory.db.get(put_id).then(function(doc){self.Memory.db.remove(doc).then(function(doc){if(boomark_type=="bookmark"){self.plugIns["bookmarks_tmpl"].setContext()}if(boomark_type=="places"){self.plugIns["favourites_tmpl"].setContext()}if($("#leaf_"+leafid).length>0){if(boomark_type=="bookmark"){$("#leaf_"+leafid).find(".bookmark_plugin").attr("checked",false)}else if(boomark_type=="places"){$("#leaf_"+leafid).find(".favourite").removeClass("favourite")}}}).catch(function(err){})})}).catch(function(err){})})};this.receivePushNotification=function(){if(app.roaming=="off"){return 0}var ping_host="http://www.oneappy.com/api/m.php?m=servertime";$.ajax({type:"POST",url:ping_host,success:function(data){var ret_t=jQuery.parseJSON(data);var note_date=ret_t["curtime"];var stringToEncode=app.appy_uid+"."+note_date;var hash=window.btoa(stringToEncode);var self=app.current_hotel;var hotel_id="";var user_id="";if(app.current_hotel.user_id!=""){user_id="&id="+app.current_hotel.pushnote_id;hotel_id=""}else{user_id="";hotel_id="&hotel_id="+app.current_hotel.id}var offset_time=1*24*60*60;var push_time_stamp=app.current_hotel.push_last_receive-offset_time;var host="http://www.oneappy.com/api/m.php?m=pushnotifications"+user_id+hotel_id+"&timestamp="+push_time_stamp+"&hash="+hash;console.log(host);method="POST";$.ajax({type:method,url:host,success:function(data){ret=jQuery.parseJSON(data);if(ret["vip_pass"]=="true"){self.vip_pass="true";self.checkifVIPenabled(self.vip_pass);$(".vipEnabled").removeClass("hidden");$(".enableVip").hide()}else{self.vip_pass="false";self.checkifVIPenabled(self.vip_pass);$(".vipEnabled").addClass("hidden");$(".enableVip").show()}self.addPushNotifications(ret["items"])},error:function(err){}})},error:function(err){}})};this.addPushNotifications=function(notes){var counter=0;var self=this;self.Memory.db.get(self.id).then(function(doc){doc.push_last_receive=Math.floor(Date.now()/1e3);self.push_last_receive=doc.push_last_receive;self.Memory.db.put(doc).then(function(){}).catch(function(){})}).catch(function(){});if(notes!=null){for(i=0;i<notes.length;i++){notes[i]["delete_id"]=self.id;notes[i]["timestamp"]=Date.now();self.Memory.db.put(notes[i]).then(function(){counter++;$(".new_msgs").html(counter);if(counter>0){$(".new_msgs").show()}}).catch(function(){})}}};this.cleanUpPushNotifications=function(){var self=this;if(!Date.now){Date.now=function(){return(new Date).getTime()}}var lifespan_ms=this.notes_lifespan*864e5;var last_message=Date.now()-lifespan_ms;self.Memory.db.query("doc_type",{key:"pushNote",include_docs:true,attachments:false}).then(function(result){var messages_array=[];result.rows.forEach(function(row){if(row.doc.timestamp<last_message){self.Memory.db.remove(row.doc._id,row.doc._rev)}})}).catch(function(err){})};this.checkifVIPenabled=function(vipenabled){var self=this;if(vipenabled=="true"){self.Memory.db.get(self.id).then(function(doc){if(doc.vip_pass==vipenabled){}else{self.enableVip(false)}}).catch(function(){})}else{self.Memory.db.get(self.id).then(function(doc){if(doc.vip_pass=="true"){self.vip_pass=vipenabled;self.menu.vipEnabled=vipenabled;doc.vip_pass=vipenabled;doc.user_id="";$(".vipEnabled").addClass("hidden");$("#menu_username").html("");$("#menu_room_no").html("");$("#menu_vip_enabled").html("");$(".enableVip").show();$(".menu_plugins").html(self.menu.renderPlugIns());self.Memory.db.put(doc)}else{}}).catch(function(){})}};this.enableVip=function(qr_flag){if(app.roaming=="off"){var msg="Network traffic is disabled for one Appy. Enable from the top bar in order to be able to check in";display_info_message(msg);return 0}var self=this;if(qr_flag){cordova.plugins.barcodeScanner.scan(function(result){if(result.cancelled==0){self.enable_vip_actions(result.text)}})}else{self.enable_vip_actions(self.id)}};this.enable_vip_actions=function(g_id){var self=this;var ping_host="http://www.oneappy.com/api/m.php?m=servertime";$.ajax({type:"POST",url:ping_host,success:function(data){var ret_t=jQuery.parseJSON(data);var note_date=ret_t["curtime"];var stringToEncode=app.appy_uid+"."+note_date;var hash=window.btoa(stringToEncode);var host="http://www.oneappy.com/api/m.php?m=guestactivate&hash="+hash+"&id="+g_id;method="post";$.ajax({type:method,url:host,success:function(data){ret=jQuery.parseJSON(data);if(ret["vip_pass"]=="true"&&ret["_id"]==self.id){self.user_name=ret["user_name"];self.user_surname=ret["user_surname"];self.user_sex=ret["user_sex"];self.vip_pass=ret["vip_pass"];self.user_title=ret["user_title"];self.user_id=ret["user_id"];self.room_number=ret["room_number"];self.menu.vipEnabled="true";self.pushnote_id=ret["pushnote_id"];if(self.vip_pass=="true"){$(".vipEnabled").removeClass("hidden");$("#menu_username").html(self.user_title+" "+self.user_name+" "+self.user_surname);$("#menu_room_no").html(self.room_number);$("#menu_vip_enabled").html("Signed In");$(".enableVip").hide()}else{$(".vipEnabled").addClass("hidden");$("#menu_username").html("");$("#menu_room_no").html("");$("#menu_vip_enabled").html("")}self.Memory.db.get(self.id).then(function(doc){doc.user_name=self.user_name;doc.user_surname=self.user_surname;doc.user_sex=self.user_sex;doc.user_enabled_counter=self.user_enabled_counter;doc.vip_pass=self.vip_pass;doc.user_title=self.user_title;doc.user_id=self.user_id;doc.room_number=self.room_number;doc.pushnote_id=self.pushnote_id;$(".menu_plugins").html(self.menu.renderPlugIns());self.receivePushNotification();return self.Memory.db.put(doc)}).then(function(response){}).catch(function(err){})}else{}},error:function(err){var msg="There appears to be a problem with the network, please try again once you are connected to the Internet";display_info_message(msg)}})},error:function(err){}})};this.initialize()}